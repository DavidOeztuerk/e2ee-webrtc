version: '3.8'

# E2EE WebRTC Server Stack
# Self-hosted infrastructure for end-to-end encrypted video calls
#
# Usage:
#   docker-compose up -d
#
# Components:
#   - signaling: WebSocket signaling server for WebRTC negotiation
#   - turn: TURN/STUN server for NAT traversal
#   - coturn: Production TURN server (alternative to turn)
#   - redis: Session state and pub/sub for scaling
#
# Note: SFU (mediasoup) runs separately - see sfu/ directory

services:
  # Signaling Server
  # Handles WebRTC offer/answer exchange and key distribution
  signaling:
    build:
      context: ../signaling
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=info
      - CORS_ORIGINS=*
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
    depends_on:
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis for pub/sub and session management
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # TURN Server (coturn) for NAT traversal
  # Required when peers are behind symmetric NAT
  coturn:
    image: coturn/coturn:4.6
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "5349:5349/tcp"
      - "5349:5349/udp"
      - "49152-49200:49152-49200/udp"
    volumes:
      - ./turnserver.conf:/etc/coturn/turnserver.conf:ro
    environment:
      - DETECT_EXTERNAL_IP=yes
      - DETECT_RELAY_IP=yes
    restart: unless-stopped

volumes:
  redis-data:

networks:
  default:
    name: e2ee-webrtc
