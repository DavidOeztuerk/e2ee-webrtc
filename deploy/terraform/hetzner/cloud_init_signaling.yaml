#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - curl
  - htop
  - vim

users:
  - name: e2ee
    groups: docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

write_files:
  - path: /opt/e2ee-webrtc/.env
    content: |
      REDIS_URL=redis://:${redis_password}@${redis_host}:6379
      NODE_ENV=${environment}
      PORT=3001
      LOG_LEVEL=info
    permissions: '0600'

  - path: /opt/e2ee-webrtc/docker-compose.yml
    content: |
      version: '3.8'

      services:
        signaling:
          image: ghcr.io/your-org/e2ee-signaling:latest
          ports:
            - "3001:3001"
            - "80:80"
          env_file:
            - .env
          restart: unless-stopped
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
          logging:
            driver: "json-file"
            options:
              max-size: "10m"
              max-file: "3"

  - path: /etc/systemd/system/e2ee-signaling.service
    content: |
      [Unit]
      Description=E2EE WebRTC Signaling Server
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/e2ee-webrtc
      ExecStart=/usr/bin/docker-compose up -d
      ExecStop=/usr/bin/docker-compose down
      TimeoutStartSec=0

      [Install]
      WantedBy=multi-user.target

runcmd:
  - systemctl enable docker
  - systemctl start docker
  - systemctl enable e2ee-signaling
  - systemctl start e2ee-signaling
  # Set up automatic updates
  - echo "0 4 * * * root cd /opt/e2ee-webrtc && docker-compose pull && docker-compose up -d" >> /etc/crontab
