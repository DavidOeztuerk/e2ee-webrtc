# Main Playbook - Deploy entire E2EE WebRTC infrastructure
---
- name: Deploy E2EE WebRTC Infrastructure
  hosts: all
  become: true

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install common packages
      apt:
        name:
          - curl
          - htop
          - vim
          - jq
          - ufw
          - fail2ban
          - unattended-upgrades
        state: present
      when: ansible_os_family == "Debian"

  roles:
    - role: common
      tags: common

- name: Deploy Redis
  hosts: redis
  become: true
  roles:
    - role: redis
      tags: redis

- name: Deploy Signaling Servers
  hosts: signaling
  become: true
  roles:
    - role: docker
      tags: docker
    - role: signaling
      tags: signaling

- name: Deploy TURN Servers
  hosts: turn
  become: true
  roles:
    - role: turn
      tags: turn

- name: Post-deployment health checks
  hosts: all
  tasks:
    - name: Check service health
      uri:
        url: "http://localhost:{{ health_check_port | default('3001') }}/health"
        method: GET
        status_code: 200
      register: health_check
      retries: 5
      delay: 10
      until: health_check.status == 200
      when: role == 'signaling'
      ignore_errors: yes

    - name: Report deployment status
      debug:
        msg: "Deployment completed for {{ inventory_hostname }} ({{ role }})"
